<!DOCTYPE html>
<html>
    <head>
        <title>Typing Speed Measurement</title>
        <style>
            /* CSS 스타일링 */
            body {
                font-family: Arial, sans-serif;
            }
            h1 {
                text-align: center;
            }
            label {
                display: block;
                margin-bottom: 10px;
            }
            input[type="text"] {
                width: 300px;
                padding: 5px;
                font-size: 16px;
            }
            button {
                padding: 10px 20px;
                font-size: 16px;
                cursor: pointer;
            }
            #result,
            #timer {
                margin-top: 20px;
                font-size: 18px;
            }
            .highlight {
                color: red;
                font-weight: bold;
            }
        </style>
    </head>
    <body>
        <h1>Typing Speed Measurement</h1>
        <form id="typing-form">
            <label for="student-id">Student ID:</label>
            <input type="text" id="student-id" required /><br /><br />
            <label for="name">Name:</label>
            <input type="text" id="name" required /><br /><br />
            <label for="typed-text">Typed Text:</label>
            <input type="text" id="typed-text" onkeyup="enterkey()" required /><br /><br />
            <button type="button" id="start-button">Start</button>
            <button type="button" id="end-button">End</button>
            <button type="button" id="reset-button">Reset</button>
            <!-- 재설정 버튼 -->
            <button type="button" id="save-button">Save</button>
            <!-- 저장 버튼 -->
        </form>
        <div id="sentence"></div>
        <!-- 입력해야 할 문장 표시 -->
        <div id="result"></div>
        <div id="timer"></div>
        <script>
            var startButton = document.getElementById("start-button");
            var endButton = document.getElementById("end-button");
            var resetButton = document.getElementById("reset-button");
            var saveButton = document.getElementById("save-button");
            var typingForm = document.getElementById("typing-form");
            var resultDiv = document.getElementById("result");
            var timerDiv = document.getElementById("timer");
            var sentenceDiv = document.getElementById("sentence");
            var start_time, end_time;
            var started = false;
            var given_text = ""; // 입력해야 할 문장
            var errorIndices = []; // 틀린 부분 인덱스 저장
            sentenceDiv.innerHTML = ""; // 초기화

            // 명언 목록
            var quotes = [
                "The only way to do great work is to love what you do. - Steve Jobs",
                "In the middle of every difficulty lies opportunity. - Albert Einstein",
                "Believe you can and you're halfway there. - Theodore Roosevelt",
                "Success is not final, failure is not fatal: It is the courage to continue that counts. - Winston Churchill",
                "The journey of a thousand miles begins with one step. - Lao Tzu",
            ];

            // 랜덤 명언 선택
            given_text = quotes[Math.floor(Math.random() * quotes.length)];

            // 입력된 텍스트와 주어진 텍스트 비교하여 틀린 부분 표시
            function showErrors() {
                var typed_text = document.getElementById("typed-text").value;
                typed_text = typed_text.trim();
                errorIndices = [];
                for (var i = 0; i < given_text.length; i++) {
                    if (given_text[i] !== typed_text[i]) {
                        errorIndices.push(i);
                    }
                }
                var sentenceHTML = "";
                for (var j = 0; j < given_text.length; j++) {
                    if (errorIndices.includes(j)) {
                        sentenceHTML += "<span class='highlight'>" + given_text[j] + "</span>";
                    } else {
                        sentenceHTML += given_text[j];
                    }
                }
                sentenceDiv.innerHTML = sentenceHTML;
            }

            // 엔터 키 입력 시 타자 속도 측정
            document.getElementById("typed-text").addEventListener("keypress", function (event) {
                if (!started) {
                    start_time = new Date();
                    started = true;
                }
                if (event.keyCode == 13) {
                    end_time = new Date();
                    var time = end_time - start_time;
                    if (document.getElementById("typed-text").value.trim() !== given_text) {
                        resultDiv.innerHTML = "Error: Typed text does not match the given text";
                    } else {
                        resultDiv.innerHTML = "Typing Speed: " + calculateTypingSpeed(time) + " WPM";
                    }
                }
            });

            // 종료 버튼 클릭 시 타자 속도 측정 및 결과 출력
            endButton.addEventListener("click", function () {
                if (!start_time) {
                    resultDiv.innerHTML = "Error: Please click the Start button first";
                    return;
                }
                end_time = new Date();
                var time_diff = end_time - start_time;
                var typed_text = document.getElementById("typed-text").value;
                typed_text = typed_text.trim();
                if (typed_text !== given_text) {
                    resultDiv.innerHTML = "Error: Typed text does not match the given text";
                    return;
                }
                resultDiv.innerHTML = "Your typing speed: " + calculateTypingSpeed(time_diff) + " WPM";
            });

            // 저장 버튼 클릭 시 결과 저장
            saveButton.addEventListener("click", function () {
                if (!start_time || !end_time) {
                    resultDiv.innerHTML = "Error: Please complete the typing test first";
                    return;
                }
                var student_id = document.getElementById("student-id").value;
                var name = document.getElementById("name").value;
                var typing_speed = calculateTypingSpeed(end_time - start_time);
                var result = {
                    student_id: student_id,
                    name: name,
                    typing_speed: typing_speed,
                };
                var jsonData = JSON.stringify(result);
                var blob = new Blob([jsonData], { type: "application/json" });
                var url = URL.createObjectURL(blob);
                var a = document.createElement("a");
                a.href = url;
                a.download = "Result.json";
                a.click();
                resultDiv.innerHTML = "Results saved successfully!";
            });

            // 재설정 버튼 클릭 시 초기화
            resetButton.addEventListener("click", function () {
                start_time = null;
                end_time = null;
                started = false;
                document.getElementById("typed-text").value = "";
                resultDiv.innerHTML = "";
                timerDiv.innerHTML = "";
                given_text = quotes[Math.floor(Math.random() * quotes.length)];
                sentenceDiv.innerHTML = given_text;
            });

            // 1초마다 경과 시간 표시
            setInterval(function () {
                if (start_time && !end_time) {
                    var current_time = new Date();
                    var time_diff = current_time - start_time;
                    timerDiv.innerHTML = "Timer: " + Math.floor(time_diff / 1000) + " seconds";
                }
            }, 1000);

            // 타자 속도 계산 함수
            function calculateTypingSpeed(time) {
                var wordsTyped = document.getElementById("typed-text").value.trim().split(" ").length;
                var minutes = time / 60000; // milliseconds to minutes
                var typing_speed = Math.round(wordsTyped / minutes);
                return typing_speed;
            }

            // 초기화
            given_text = quotes[Math.floor(Math.random() * quotes.length)];
            sentenceDiv.innerHTML = given_text;
        </script>
    </body>
</html>
